{#
  Article Card Partial - EXACT match to frontend/src/components/articles/ArticleCard.tsx

  Expected context:
    - article: dict with keys matching Article schema
    - view_mode: "grid" or "list" (default: "grid")
    - is_selected: boolean (default: false)
#}

{% from 'components/icons.html' import source_icon, status_icon, clock, check %}
{% from 'components/badge.html' import badge, media_type_badge %}

{% set view_mode = view_mode|default('grid') %}
{% set is_selected = is_selected|default(false) %}

{# ArticleCard.tsx line 36: summaryPreview computation #}
{% set ns = namespace(summary_preview='') %}
{% for line in (article.summary or '').split('\n') %}
    {% if line.strip() and not line.strip().startswith('#') and not ns.summary_preview %}
        {% set ns.summary_preview = line.strip()[:200] %}
    {% endif %}
{% endfor %}
{% set summary_preview = ns.summary_preview %}

{# ArticleCard.tsx line 37: externalLink computation #}
{% set external_link = article.original_url if article.original_url else 'https://www.google.com/search?q=' + (article.title or '')|urlencode %}

{# ArticleCard.tsx line 33: isProcessing computation #}
{% set is_processing = article.processing_status == 'processing' %}
{% set is_pending = article.processing_status == 'pending' %}
{% set needs_polling = is_processing or is_pending %}

{# ArticleCard.tsx line 34: isFailed computation #}
{% set is_failed = article.processing_status == 'failed' %}

{# Wrapper div for HTMX polling when processing #}
{% if needs_polling %}
<div
    id="article-card-{{ article.id }}"
    hx-get="/app/article/{{ article.id }}/card?view_mode={{ view_mode }}"
    hx-trigger="every 3s"
    hx-swap="outerHTML"
>
{% endif %}

{% if view_mode == 'list' %}
{# ============================================================================
   LIST VIEW - ArticleCard.tsx lines 59-146
   ============================================================================ #}

{# Lines 61-68: Root container - click handled by JS #}
<div
    data-article-id="{{ article.id }}"
    data-article-url="/app/article/{{ article.id }}"
    onclick="handleArticleClick(event, '{{ article.id }}')"
    class="flex items-start gap-4 p-4 bg-dark-surface border rounded-lg transition-colors cursor-pointer {% if is_selected %}border-article-blue bg-article-blue/5{% else %}border-dark-border hover:border-dark-hover hover:bg-dark-hover/50{% endif %}"
>
    {# Lines 71-76: Color indicator - vertical bar on left #}
    {% if article.color %}
    <div class="w-1 self-stretch rounded-full flex-shrink-0" style="background-color: {{ article.color.hex_value }};"></div>
    {% endif %}

    {# Line 79: Content wrapper #}
    <div class="flex-1 min-w-0">
        {# Line 80: Inner content #}
        <div class="flex items-start gap-3">
            {# Line 81: SourceIcon #}
            {{ source_icon(article.source_type, 'w-4 h-4 text-dark-muted mt-1 flex-shrink-0') }}

            {# Line 82: Text content #}
            <div class="flex-1 min-w-0">
                {# Line 83: Title row #}
                <div class="flex items-center gap-2">
                    {# Read/Unread indicator: ðŸŒ¹ for read, ðŸ¥€ for unread #}
                    <span class="flex-shrink-0 text-sm" title="{{ 'Read' if article.is_read else 'Unread' }}">{{ 'ðŸŒ¹' if article.is_read else 'ðŸ¥€' }}</span>
                    {# Line 87: Title #}
                    <h3 class="font-medium text-white truncate">{{ article.title }}</h3>
                </div>

                {# Lines 89-91: Summary - CONDITIONAL: summaryPreview #}
                {% if summary_preview %}
                <p class="text-sm text-dark-muted mt-1 line-clamp-2">{{ summary_preview }}</p>
                {% endif %}

                {# Line 92: Tags container #}
                <div class="flex items-center gap-2 mt-2">
                    {# Lines 93-97: Category badges - LOOP: categories.slice(0, 1) #}
                    {% for cat in (article.categories or [])[:1] %}
                    {{ badge(cat.name, color='#6B7280', variant='outline', size='sm') }}
                    {% endfor %}
                    {# Lines 98-102: Tag badges - LOOP: tags.slice(0, 3) #}
                    {% for tag in (article.tags or [])[:3] %}
                    {{ badge(tag.name, color=tag.color or '#8B5CF6', size='sm') }}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    {# Line 109: Meta section #}
    <div class="flex items-center gap-3 flex-shrink-0 text-sm text-dark-muted">
        {# Lines 110-115: Reading time - CONDITIONAL: reading_time_minutes #}
        {% if article.reading_time_minutes %}
        <span class="flex items-center gap-1">
            {# Line 112: Clock icon - w-3.5 h-3.5 in list view #}
            {{ clock('w-3.5 h-3.5') }}
            {# Line 113: Text - "{n} min" in list view #}
            {{ article.reading_time_minutes }} min
        </span>
        {% endif %}

        {# Lines 116-120: StatusIcon - CONDITIONAL: StatusIcon exists (not completed) #}
        {% if article.processing_status != 'completed' %}
        {{ status_icon(article.processing_status, 'w-4 h-4' + (' animate-spin' if is_processing else '') + (' text-article-red' if is_failed else '')) }}
        {% endif %}

        {# Line 121: MediaTypeBadge #}
        {{ media_type_badge(article.media_type) }}

        {# Lines 122-131: Paperclip link #}
        <a
            href="{{ external_link }}"
            target="_blank"
            rel="noopener noreferrer"
            onclick="event.stopPropagation()"
            class="hover:text-article-blue transition-colors"
            title="{{ 'Open source' if article.original_url else 'Search on Google' }}"
        >ðŸ“Ž</a>

        {# Lines 133-143: Checkbox button #}
        <button
            type="button"
            onclick="event.stopPropagation(); toggleArticleSelection('{{ article.id }}')"
            class="article-checkbox w-5 h-5 rounded border-2 flex-shrink-0 flex items-center justify-center transition-colors {% if is_selected %}bg-article-blue border-article-blue{% else %}border-dark-border hover:border-dark-muted{% endif %}"
        >
            {# Checkmark - always rendered, hidden by default, shown via JS when selected #}
            <span class="checkmark {% if not is_selected %}hidden{% endif %}">{{ check('w-3 h-3 text-white') }}</span>
        </button>
    </div>
</div>

{% else %}
{# ============================================================================
   GRID VIEW - ArticleCard.tsx lines 150-248
   ============================================================================ #}

{# Lines 151-158: Root container - click handled by JS #}
<div
    data-article-id="{{ article.id }}"
    data-article-url="/app/article/{{ article.id }}"
    onclick="handleArticleClick(event, '{{ article.id }}')"
    class="flex flex-col p-4 bg-dark-surface border rounded-lg transition-colors h-full cursor-pointer {% if is_selected %}border-article-blue bg-article-blue/5{% else %}border-dark-border hover:border-dark-hover hover:bg-dark-hover/50{% endif %}"
>
    {# Line 161: Header #}
    <div class="flex items-start justify-between gap-2 mb-3">
        {# Line 162: Header left side #}
        <div class="flex items-center gap-2">
            {# Line 163: SourceIcon #}
            {{ source_icon(article.source_type, 'w-4 h-4 text-dark-muted') }}
            {# Lines 164-169: Color dot - CONDITIONAL: articleColor #}
            {% if article.color %}
            <div class="w-2 h-2 rounded-full" style="background-color: {{ article.color.hex_value }};"></div>
            {% endif %}
        </div>

        {# Line 171: Header right side #}
        <div class="flex items-center gap-2">
            {# Lines 172-180: StatusIcon - CONDITIONAL: StatusIcon exists (not completed) #}
            {% if article.processing_status != 'completed' %}
            {{ status_icon(article.processing_status, 'w-4 h-4' + (' animate-spin text-article-blue' if is_processing else '') + (' text-article-red' if is_failed else '')) }}
            {% endif %}

            {# Lines 182-192: Checkbox button #}
            <button
                type="button"
                onclick="event.stopPropagation(); toggleArticleSelection('{{ article.id }}')"
                class="article-checkbox w-5 h-5 rounded border-2 flex-shrink-0 flex items-center justify-center transition-colors {% if is_selected %}bg-article-blue border-article-blue{% else %}border-dark-border hover:border-dark-muted{% endif %}"
            >
                {# Checkmark - always rendered, hidden by default, shown via JS when selected #}
                <span class="checkmark {% if not is_selected %}hidden{% endif %}">{{ check('w-3 h-3 text-white') }}</span>
            </button>
        </div>
    </div>

    {# Line 197: Title section #}
    <div class="flex items-start gap-2 mb-2">
        {# Read/Unread indicator: ðŸŒ¹ for read, ðŸ¥€ for unread #}
        <span class="flex-shrink-0 text-sm mt-0.5" title="{{ 'Read' if article.is_read else 'Unread' }}">{{ 'ðŸŒ¹' if article.is_read else 'ðŸ¥€' }}</span>
        {# Line 201: Title #}
        <h3 class="font-medium text-white line-clamp-2">{{ article.title }}</h3>
    </div>

    {# Lines 205-207: Summary - CONDITIONAL: summaryPreview #}
    {% if summary_preview %}
    <p class="text-sm text-dark-muted line-clamp-3 mb-3 flex-1">{{ summary_preview }}</p>
    {% endif %}

    {# Line 210: Categories & Tags container #}
    <div class="flex flex-wrap gap-1.5 mt-auto">
        {# Lines 211-215: Category badges - LOOP: categories.slice(0, 1) #}
        {% for cat in (article.categories or [])[:1] %}
        {{ badge(cat.name, color='#6B7280', variant='outline', size='sm') }}
        {% endfor %}
        {# Lines 216-220: Tag badges - LOOP: tags.slice(0, 2) #}
        {% for tag in (article.tags or [])[:2] %}
        {{ badge(tag.name, color=tag.color or '#8B5CF6', size='sm') }}
        {% endfor %}
    </div>

    {# Line 224: Footer #}
    <div class="mt-3 pt-3 border-t border-dark-border flex justify-between items-center">
        {# Lines 225-232: Reading time or empty span #}
        {% if article.reading_time_minutes %}
        <span class="flex items-center gap-1 text-xs text-dark-muted">
            {# Line 227: Clock icon - w-3 h-3 in grid view #}
            {{ clock('w-3 h-3') }}
            {# Line 228: Text - "{n} min read" in grid view #}
            {{ article.reading_time_minutes }} min read
        </span>
        {% else %}
        {# Line 231: Empty span when no reading time #}
        <span></span>
        {% endif %}

        {# Line 233: Footer right side #}
        <div class="flex items-center gap-2">
            {# Line 234: MediaTypeBadge #}
            {{ media_type_badge(article.media_type) }}
            {# Lines 235-244: Paperclip link #}
            <a
                href="{{ external_link }}"
                target="_blank"
                rel="noopener noreferrer"
                onclick="event.stopPropagation()"
                class="text-dark-muted hover:text-article-blue transition-colors"
                title="{{ 'Open source' if article.original_url else 'Search on Google' }}"
            >ðŸ“Ž</a>
        </div>
    </div>
</div>
{% endif %}

{# Close polling wrapper if it was opened #}
{% if needs_polling %}
</div>
{% endif %}
