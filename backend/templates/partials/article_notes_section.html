{#
  Article Notes Section Partial

  Expected context:
    - article: dict with id, notes (list of dicts with id, content, created_at)
#}

{% from 'components/icons.html' import trash_2, plus %}

<div
    id="article-notes-section"
    class="bg-dark-surface border border-dark-border rounded-lg p-4"
    x-data="notesEditor('{{ article.id }}')"
    x-init="initEditor()"
>
    <h3 class="text-sm font-semibold text-white mb-3">Notes</h3>

    {# Add new note form #}
    <form
        x-ref="noteForm"
        hx-post="/app/article/{{ article.id }}/notes"
        hx-target="#article-notes-section"
        hx-swap="outerHTML"
        @submit="beforeSubmit($event)"
        class="mb-4 notes-editor"
    >
        {# Hidden input - kept in sync with Quill on every change #}
        <input type="hidden" name="content" x-ref="contentInput">

        {# Quill editor container #}
        <div x-ref="editorContainer"></div>

        <div class="flex items-center justify-between mt-3">
            <span x-show="hasDraft" class="text-xs text-dark-muted flex items-center gap-1">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path>
                </svg>
                Draft saved
            </span>
            <span x-show="!hasDraft" class="flex-1"></span>
            <button
                type="submit"
                class="flex items-center gap-1 px-3 py-1.5 bg-article-blue text-white text-sm rounded-lg hover:bg-article-blue/90 transition-colors"
            >
                {{ plus("w-4 h-4") }}
                Add Note
            </button>
        </div>
    </form>

    {# Notes list - displaying HTML directly #}
    {% if article.notes %}
    <div class="space-y-3">
        {% for note in article.notes %}
        <div class="bg-dark-bg border border-dark-border rounded-lg p-3">
            <div class="text-sm text-dark-text prose-dark note-content">{{ note.content|safe }}</div>
            <div class="flex items-center justify-between mt-2 pt-2 border-t border-dark-border">
                <span class="text-xs text-dark-muted">
                    {{ note.created_at.strftime('%b %d, %Y') if note.created_at else '' }}
                </span>
                <button
                    hx-delete="/app/article/{{ article.id }}/notes/{{ note.id }}"
                    hx-target="#article-notes-section"
                    hx-swap="outerHTML"
                    hx-confirm="Delete this note?"
                    class="p-1 text-dark-muted hover:text-article-red transition-colors"
                >
                    {{ trash_2("w-3.5 h-3.5") }}
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-sm text-dark-muted text-center py-2">No notes yet</p>
    {% endif %}
</div>

<script>
    function notesEditor(articleId) {
        return {
            editor: null,
            hasDraft: false,
            storageKey: `alexandria-note-draft-${articleId}`,

            initEditor() {
                // Wait for Quill to be available
                if (typeof Quill === 'undefined') {
                    setTimeout(() => this.initEditor(), 100);
                    return;
                }

                const container = this.$refs.editorContainer;

                // Initialize Quill
                this.editor = new Quill(container, {
                    theme: 'snow',
                    placeholder: 'Add a note...',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline', 'strike'],
                            ['blockquote', 'code-block'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['link'],
                            ['clean']
                        ]
                    }
                });

                // Load draft
                const savedDraft = localStorage.getItem(this.storageKey);
                if (savedDraft) {
                    try {
                        this.editor.root.innerHTML = savedDraft;
                        this.hasDraft = true;
                        // Sync to hidden input immediately
                        this.syncToHiddenInput();
                    } catch (e) {
                        console.error('Error loading draft:', e);
                    }
                }

                // On EVERY text change: save draft AND sync to hidden input
                this.editor.on('text-change', () => {
                    this.saveDraft();
                    this.syncToHiddenInput();
                });
            },

            syncToHiddenInput() {
                if (!this.editor || !this.$refs.contentInput) return;
                const html = DOMPurify.sanitize(this.editor.root.innerHTML);
                this.$refs.contentInput.value = html;
            },

            saveDraft() {
                if (!this.editor) return;
                const content = this.editor.root.innerHTML;
                const text = this.editor.getText().trim();

                if (text) {
                    localStorage.setItem(this.storageKey, content);
                    this.hasDraft = true;
                } else {
                    localStorage.removeItem(this.storageKey);
                    this.hasDraft = false;
                }
            },

            clearDraft() {
                localStorage.removeItem(this.storageKey);
                this.hasDraft = false;
                if (this.editor) {
                    this.editor.setText('');
                }
                if (this.$refs.contentInput) {
                    this.$refs.contentInput.value = '';
                }
            },

            beforeSubmit(event) {
                if (!this.editor) return;

                const text = this.editor.getText().trim();
                if (!text) {
                    event.preventDefault();
                    return false;
                }

                // Final sync before submit (belt and suspenders)
                this.syncToHiddenInput();

                // Clear draft after successful submit
                // Use setTimeout to let HTMX process first
                setTimeout(() => {
                    localStorage.removeItem(this.storageKey);
                }, 100);
            }
        };
    }
</script>
