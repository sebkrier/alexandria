{#
  Sidebar Partial - matches frontend/src/components/layout/Sidebar.tsx

  Expected context:
    - categories: list of category dicts with children, article_count
    - colors: list of color dicts with id, name, hex_value
    - unread_count: int
    - current_path: current URL path
    - selected_category_id: currently selected category (optional)
    - selected_color_id: currently selected color (optional)
#}

{% from 'components/icons.html' import library, settings, plus, chevron_right, chevron_down, circle_small, smartphone, book_open, menu, message_circle %}

{% set current_path = current_path|default('/app/') %}

{# Recursive macro for category items #}
{% macro category_item(category, depth=0, selected_category_id=none) %}
{% set has_children = category.children and category.children|length > 0 %}
{% set is_selected = selected_category_id == category.id %}
{% set is_parent = depth == 0 %}

<div x-data="{ expanded: false }">
    <button
        hx-get="/app/articles?category_id={{ category.id }}"
        hx-target="#articles-container"
        hx-push-url="true"
        @click="if ($event.target.closest('.expand-btn')) { $event.preventDefault(); expanded = !expanded; }"
        class="w-full flex items-center gap-2 px-3 py-1 text-xs rounded-lg transition-colors {% if is_selected %}bg-article-blue/20 text-article-blue{% else %}text-dark-muted hover:text-dark-text hover:bg-dark-hover{% endif %}{% if is_parent %} font-medium{% endif %}"
        style="padding-left: {{ 12 + depth * 16 }}px;"
    >
        {% if has_children %}
        <span class="expand-btn p-0.5 hover:bg-dark-hover rounded" @click.stop="expanded = !expanded">
            <template x-if="expanded">{{ chevron_down('w-3.5 h-3.5') }}</template>
            <template x-if="!expanded">{{ chevron_right('w-3.5 h-3.5') }}</template>
        </span>
        {% else %}
        {{ circle_small('w-2 h-2 ml-1 mr-1 ' + ('text-article-blue' if is_selected else 'text-dark-muted/50')) }}
        {% endif %}
        <span class="flex-1 text-left truncate">{{ category.name }}</span>
        <span class="text-xs {% if is_selected %}text-article-blue{% else %}text-dark-muted{% endif %}">
            {{ category.article_count|default(0) }}
        </span>
    </button>

    {% if has_children %}
    <div x-show="expanded" x-cloak class="border-l border-dark-border/50 ml-5">
        {% for child in category.children %}
        {{ category_item(child, depth + 1, selected_category_id) }}
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endmacro %}

<aside class="w-64 h-screen bg-dark-surface border-r border-dark-border flex flex-col flex-shrink-0">
    {# Logo #}
    <div class="px-4 py-4 border-b border-dark-border">
        <a href="/app/" class="flex items-center gap-2">
            {{ library('w-6 h-6 text-article-blue') }}
            <span class="text-lg font-semibold text-white">Alexandria</span>
        </a>
    </div>

    {# Add Article/Video Button #}
    <div class="px-3 py-3">
        <button
            hx-get="/app/modals/add-article"
            hx-target="#modal-container"
            hx-swap="innerHTML"
            class="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-article-blue text-white rounded-lg hover:bg-article-blue/90 transition-colors"
        >
            {{ plus('w-4 h-4') }}
            <span class="font-medium">Add Article/Video</span>
        </button>
    </div>

    {# Navigation #}
    <nav class="px-3 py-2">
        {# Read Unread Link #}
        {% if unread_count is defined and unread_count > 0 %}
        <a
            href="/app/reader"
            class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors mb-1 {% if '/reader' in current_path %}bg-article-blue/20 text-article-blue{% else %}text-white bg-dark-hover hover:bg-dark-hover/80{% endif %}"
        >
            {{ book_open('w-5 h-5') }}
            <span class="flex-1">Read Unread</span>
            <span class="text-xs px-2 py-0.5 rounded-full font-medium {% if '/reader' in current_path %}bg-article-blue text-white{% else %}bg-article-blue/20 text-article-blue{% endif %}">
                {{ unread_count }}
            </span>
        </a>
        {% endif %}

        {# Main nav items #}
        <a
            href="/app/"
            class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors {% if current_path == '/app/' and not selected_category_id and not selected_color_id %}bg-dark-hover text-white{% else %}text-dark-muted hover:text-dark-text hover:bg-dark-hover{% endif %}"
        >
            {{ library('w-5 h-5') }}
            <span>Library</span>
        </a>

        <a
            href="/app/ask"
            class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors {% if '/ask' in current_path %}bg-dark-hover text-white{% else %}text-dark-muted hover:text-dark-text hover:bg-dark-hover{% endif %}"
        >
            {{ message_circle('w-5 h-5') }}
            <span>Ask</span>
        </a>

        <a
            href="/app/remote"
            class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors {% if '/remote' in current_path %}bg-dark-hover text-white{% else %}text-dark-muted hover:text-dark-text hover:bg-dark-hover{% endif %}"
        >
            {{ smartphone('w-5 h-5') }}
            <span>Remote Add</span>
        </a>

        <a
            href="/app/settings"
            class="flex items-center gap-3 px-3 py-2 rounded-lg transition-colors {% if '/settings' in current_path %}bg-dark-hover text-white{% else %}text-dark-muted hover:text-dark-text hover:bg-dark-hover{% endif %}"
        >
            {{ settings('w-5 h-5') }}
            <span>Settings</span>
        </a>
    </nav>

    {# Categories #}
    <div class="flex-1 overflow-y-auto px-3 py-4 border-t border-dark-border">
        <div class="flex items-center justify-between mb-2 px-3">
            <span class="text-xs font-semibold text-dark-muted uppercase tracking-wider">
                Categories
            </span>
        </div>
        <div class="space-y-0.5">
            {% for category in categories|default([]) %}
            {{ category_item(category, 0, selected_category_id) }}
            {% endfor %}
        </div>

        {# Colors - use partial with ID for OOB swaps #}
        {% include 'partials/sidebar_colors.html' %}
    </div>

    {# Footer with logo #}
    <div class="px-4 py-4 border-t border-dark-border flex justify-center">
        <img
            src="/static/logo.jpg"
            alt="Alexandria"
            class="h-48 w-auto object-contain opacity-80"
            onerror="this.style.display='none'"
        >
    </div>
</aside>
