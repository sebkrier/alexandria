{% extends "base.html" %}

{% block title %}{{ article.title }} - Alexandria{% endblock %}

{% block head %}
<style>
    /* Prose styling for markdown content */
    .prose-dark {
        color: #E5E7EB;
    }
    .prose-dark h1, .prose-dark h2, .prose-dark h3, .prose-dark h4 {
        color: #FFFFFF;
        margin-top: 1.5em;
        margin-bottom: 0.5em;
    }
    .prose-dark h1 { font-size: 1.5em; font-weight: 700; }
    .prose-dark h2 { font-size: 1.25em; font-weight: 600; }
    .prose-dark h3 { font-size: 1.125em; font-weight: 600; }
    .prose-dark p { margin: 1em 0; line-height: 1.625; }
    .prose-dark ul, .prose-dark ol { margin: 1em 0; padding-left: 1.5em; }
    .prose-dark li { margin: 0.25em 0; }
    .prose-dark ul { list-style-type: disc; }
    .prose-dark ol { list-style-type: decimal; }
    .prose-dark code {
        background-color: rgba(107, 127, 215, 0.1);
        padding: 0.125em 0.25em;
        border-radius: 0.25em;
        font-size: 0.875em;
    }
    .prose-dark pre {
        background-color: #1F2937;
        padding: 1em;
        border-radius: 0.5em;
        overflow-x: auto;
        margin: 1em 0;
    }
    .prose-dark pre code {
        background: none;
        padding: 0;
    }
    .prose-dark a {
        color: #6B7FD7;
        text-decoration: underline;
    }
    .prose-dark a:hover {
        color: #8B9FE7;
    }
    .prose-dark blockquote {
        border-left: 4px solid #374151;
        padding-left: 1em;
        margin: 1em 0;
        color: #9CA3AF;
    }
    .prose-dark strong { color: #FFFFFF; }
</style>
{% endblock %}

{% block body %}
{% from 'components/icons.html' import globe, file_text, graduation_cap, play_circle, arrow_left, external_link, refresh_cw, trash_2, loader_2, alert_circle, clock, palette, pencil, check, plus, x_icon %}
{% from 'components/badge.html' import badge, media_type_badge %}

<div class="min-h-screen bg-dark-bg">
    {# Header - sticky #}
    <header class="bg-dark-surface border-b border-dark-border sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <a
                href="/app/"
                class="flex items-center gap-2 text-dark-muted hover:text-dark-text transition-colors"
            >
                {{ arrow_left("w-5 h-5") }}
                <span>Back to library</span>
            </a>

            <div class="flex items-center gap-2">
                {# Reprocess button #}
                <button
                    hx-post="/app/article/{{ article.id }}/reprocess"
                    hx-swap="none"
                    class="inline-flex items-center gap-2 px-3 py-1.5 text-sm bg-dark-surface border border-dark-border rounded-lg text-dark-text hover:bg-dark-hover transition-colors"
                >
                    {{ refresh_cw("w-4 h-4") }}
                    <span>Reprocess</span>
                </button>

                {# Delete button with confirmation #}
                <div x-data="{ showConfirm: false }">
                    <template x-if="!showConfirm">
                        <button
                            @click="showConfirm = true"
                            class="p-1.5 text-dark-muted hover:text-dark-text transition-colors"
                        >
                            {{ trash_2("w-4 h-4") }}
                        </button>
                    </template>
                    <template x-if="showConfirm">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-dark-muted">Delete?</span>
                            <button
                                hx-delete="/app/article/{{ article.id }}"
                                hx-confirm="Are you sure you want to delete this article?"
                                class="px-2 py-1 text-sm bg-article-red text-white rounded hover:bg-red-600 transition-colors"
                            >
                                Yes
                            </button>
                            <button
                                @click="showConfirm = false"
                                class="px-2 py-1 text-sm bg-dark-surface border border-dark-border rounded hover:bg-dark-hover transition-colors"
                            >
                                No
                            </button>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </header>

    {# Main content #}
    <main class="max-w-7xl mx-auto px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {# Main content column #}
            <div class="lg:col-span-2">
                {# Title section #}
                <div class="mb-6">
                    <div class="flex items-center gap-3 mb-3">
                        {# Source type icon #}
                        {% if article.source_type == 'arxiv' %}
                        {{ graduation_cap("w-5 h-5 text-dark-muted") }}
                        {% elif article.source_type == 'video' %}
                        {{ play_circle("w-5 h-5 text-dark-muted") }}
                        {% elif article.source_type == 'pdf' %}
                        {{ file_text("w-5 h-5 text-dark-muted") }}
                        {% else %}
                        {{ globe("w-5 h-5 text-dark-muted") }}
                        {% endif %}

                        {# Color dot #}
                        {% if article.color %}
                        <div
                            class="w-3 h-3 rounded-full"
                            style="background-color: {{ article.color.hex_value }};"
                        ></div>
                        {% endif %}

                        <span class="text-sm text-dark-muted capitalize">{{ article.source_type }}</span>
                    </div>

                    <h1 class="text-2xl font-bold text-white">{{ article.title }}</h1>

                    {% if article.authors %}
                    <p class="text-dark-muted mt-2">{{ article.authors|join(", ") }}</p>
                    {% endif %}
                </div>

                {# Processing status banner #}
                {% if article.processing_status != 'completed' %}
                <div class="mb-6 p-4 rounded-lg border {% if article.processing_status == 'failed' %}bg-article-red/10 border-article-red/30{% else %}bg-article-blue/10 border-article-blue/30{% endif %}">
                    <div class="flex items-center gap-3">
                        {% if article.processing_status == 'processing' %}
                        {{ loader_2("w-5 h-5 text-article-blue animate-spin") }}
                        {% elif article.processing_status == 'failed' %}
                        {{ alert_circle("w-5 h-5 text-article-red") }}
                        {% else %}
                        {{ clock("w-5 h-5 text-dark-muted") }}
                        {% endif %}

                        <div>
                            <p class="font-medium text-white">
                                {% if article.processing_status == 'pending' %}Pending processing
                                {% elif article.processing_status == 'processing' %}Processing...
                                {% elif article.processing_status == 'failed' %}Processing failed
                                {% else %}{{ article.processing_status }}{% endif %}
                            </p>
                            {% if article.processing_error %}
                            <p class="text-sm text-dark-muted mt-1">{{ article.processing_error }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {# Summary #}
                {% if article.summary %}
                <div class="bg-dark-surface border border-dark-border rounded-lg p-6 mb-6">
                    <h2 class="text-lg font-semibold text-white mb-4">Summary</h2>
                    <div class="prose-dark" id="summary-content">
                        {# Render markdown - we'll use a simple approach for now #}
                        {{ article.summary|safe }}
                    </div>
                    {% if article.summary_model %}
                    <p class="mt-4 text-xs text-dark-muted">
                        Generated by {{ article.summary_model }}
                    </p>
                    {% endif %}
                </div>
                {% endif %}

                {# Original link #}
                {% if article.original_url %}
                <div class="mb-6">
                    <a
                        href="{{ article.original_url }}"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center gap-2 text-article-blue hover:underline"
                    >
                        {{ external_link("w-4 h-4") }}
                        <span>View original</span>
                    </a>
                </div>
                {% endif %}
            </div>

            {# Sidebar #}
            <div class="space-y-6">
                {# Color section #}
                <div class="bg-dark-surface border border-dark-border rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-white">Color</h3>
                        <button class="text-dark-muted hover:text-white transition-colors">
                            {{ palette("w-4 h-4") }}
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        {% if article.color %}
                        <div
                            class="w-6 h-6 rounded-full"
                            style="background-color: {{ article.color.hex_value }};"
                        ></div>
                        <span class="text-sm text-dark-text">{{ article.color.name }}</span>
                        {% else %}
                        <span class="text-sm text-dark-muted">No color</span>
                        {% endif %}
                    </div>
                </div>

                {# Categories #}
                <div class="bg-dark-surface border border-dark-border rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-white">Categories</h3>
                        <button class="text-dark-muted hover:text-white transition-colors">
                            {{ pencil("w-4 h-4") }}
                        </button>
                    </div>
                    {% if article.categories %}
                    <div class="flex flex-wrap gap-2">
                        {% for cat in article.categories %}
                        {{ badge(cat.name, size="md") }}
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-sm text-dark-muted">No categories</p>
                    {% endif %}
                </div>

                {# Tags #}
                <div class="bg-dark-surface border border-dark-border rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-white">Tags</h3>
                        <button class="text-dark-muted hover:text-white transition-colors">
                            {{ pencil("w-4 h-4") }}
                        </button>
                    </div>
                    {% if article.tags %}
                    <div class="flex flex-wrap gap-2">
                        {% for tag in article.tags %}
                        {{ badge(tag.name, color=tag.color, size="md") }}
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-sm text-dark-muted">No tags</p>
                    {% endif %}
                </div>

                {# Details/Metadata #}
                <div class="bg-dark-surface border border-dark-border rounded-lg p-4">
                    <h3 class="text-sm font-semibold text-white mb-3">Details</h3>
                    <dl class="space-y-3 text-sm">
                        <div>
                            <dt class="text-dark-muted">Added</dt>
                            <dd class="text-dark-text">{{ article.created_at.strftime('%b %d, %Y at %I:%M %p') if article.created_at else 'Unknown' }}</dd>
                        </div>
                        {% if article.publication_date %}
                        <div>
                            <dt class="text-dark-muted">Published</dt>
                            <dd class="text-dark-text">{{ article.publication_date.strftime('%b %d, %Y') }}</dd>
                        </div>
                        {% endif %}
                        <div>
                            <dt class="text-dark-muted">Source</dt>
                            <dd class="text-dark-text capitalize">{{ article.source_type }}</dd>
                        </div>
                        {% if article.reading_time_minutes %}
                        <div>
                            <dt class="text-dark-muted">Reading time</dt>
                            <dd class="text-dark-text">{{ article.reading_time_minutes }} min</dd>
                        </div>
                        {% endif %}
                    </dl>
                </div>

                {# Notes section #}
                <div class="bg-dark-surface border border-dark-border rounded-lg p-4">
                    <h3 class="text-sm font-semibold text-white mb-3">Notes</h3>

                    {# Add new note form #}
                    <div class="mb-4">
                        <textarea
                            placeholder="Add a note..."
                            rows="3"
                            class="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-dark-text placeholder-dark-muted text-sm focus:outline-none focus:ring-1 focus:ring-article-blue resize-none"
                        ></textarea>
                    </div>

                    {# Notes list #}
                    {% if article.notes %}
                    <div class="space-y-3">
                        {% for note in article.notes %}
                        <div class="bg-dark-bg border border-dark-border rounded-lg p-3">
                            <div class="text-sm text-dark-text">{{ note.content }}</div>
                            <div class="flex items-center justify-between mt-2 pt-2 border-t border-dark-border">
                                <span class="text-xs text-dark-muted">{{ note.created_at.strftime('%b %d, %Y') if note.created_at else '' }}</span>
                                <div class="flex items-center gap-1">
                                    <button class="p-1 text-dark-muted hover:text-white transition-colors">
                                        {{ pencil("w-3.5 h-3.5") }}
                                    </button>
                                    <button class="p-1 text-dark-muted hover:text-article-red transition-colors">
                                        {{ trash_2("w-3.5 h-3.5") }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-sm text-dark-muted text-center py-2">No notes yet</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}
