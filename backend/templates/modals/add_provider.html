{#
  Add AI Provider Modal

  Expected context:
    - available_providers: dict of provider info with models
#}

{% from 'components/icons.html' import x_icon, loader_2 %}

<div
    id="add-provider-modal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4"
>
    {# Backdrop #}
    <div
        class="absolute inset-0 bg-black/60 backdrop-blur-sm"
        onclick="document.getElementById('add-provider-modal').remove()"
    ></div>

    {# Modal content #}
    <div
        class="relative bg-dark-surface border border-dark-border rounded-xl shadow-2xl w-full max-w-md"
        onclick="event.stopPropagation()"
    >
        {# Header #}
        <div class="flex items-center justify-between px-6 py-4 border-b border-dark-border">
            <h2 class="text-lg font-semibold text-white">Add AI Provider</h2>
            <button
                onclick="document.getElementById('add-provider-modal').remove()"
                class="p-1.5 rounded-lg text-dark-muted hover:text-white hover:bg-dark-hover transition-colors"
            >
                {{ x_icon('w-5 h-5') }}
            </button>
        </div>

        {# Body #}
        <div class="px-6 py-4">
            <form
                id="add-provider-form"
                hx-post="/app/settings/providers"
                hx-target="#providers-list"
                hx-swap="innerHTML"
                hx-on::after-request="if(event.detail.successful) document.getElementById('add-provider-modal').remove()"
            >
                <div class="space-y-4">
                    {# Provider select #}
                    <div>
                        <label for="provider_name" class="block text-sm font-medium text-dark-text mb-1.5">
                            Provider
                        </label>
                        <select
                            name="provider_name"
                            id="provider_name"
                            onchange="updateProviderForm()"
                            class="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-article-blue"
                        >
                            {% for key, provider in available_providers.items() %}
                            <option value="{{ key }}">{{ provider.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    {# Display name #}
                    <div>
                        <label for="display_name" class="block text-sm font-medium text-dark-text mb-1.5">
                            Display Name
                        </label>
                        <input
                            type="text"
                            name="display_name"
                            id="display_name"
                            value="My Anthropic API"
                            required
                            class="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white placeholder-dark-muted focus:outline-none focus:ring-2 focus:ring-article-blue"
                        >
                        <p class="mt-1 text-xs text-dark-muted">A friendly name to identify this API key</p>
                    </div>

                    {# Model select #}
                    <div>
                        <label for="model_id" class="block text-sm font-medium text-dark-text mb-1.5">
                            Model
                        </label>

                        {# Anthropic models #}
                        <select
                            name="model_id"
                            id="model_id_anthropic"
                            class="provider-models w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-article-blue"
                            data-provider="anthropic"
                        >
                            {% if available_providers and available_providers.anthropic %}
                            {% for model_id, model_name in available_providers.anthropic.models.items() %}
                            <option value="{{ model_id }}">{{ model_name }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>

                        {# OpenAI models #}
                        <select
                            name="model_id"
                            id="model_id_openai"
                            class="provider-models w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-article-blue hidden"
                            data-provider="openai"
                        >
                            {% if available_providers and available_providers.openai %}
                            {% for model_id, model_name in available_providers.openai.models.items() %}
                            <option value="{{ model_id }}">{{ model_name }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>

                        {# Google models #}
                        <select
                            name="model_id"
                            id="model_id_google"
                            class="provider-models w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-article-blue hidden"
                            data-provider="google"
                        >
                            {% if available_providers and available_providers.google %}
                            {% for model_id, model_name in available_providers.google.models.items() %}
                            <option value="{{ model_id }}">{{ model_name }}</option>
                            {% endfor %}
                            {% endif %}
                        </select>
                    </div>

                    {# API Key #}
                    <div>
                        <label for="api_key" class="block text-sm font-medium text-dark-text mb-1.5">
                            API Key
                        </label>
                        <input
                            type="password"
                            name="api_key"
                            id="api_key"
                            placeholder="Enter your API key"
                            required
                            class="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white placeholder-dark-muted focus:outline-none focus:ring-2 focus:ring-article-blue"
                        >
                        <p id="api-key-help" class="mt-1 text-xs text-dark-muted">
                            Get your key from <a href="https://console.anthropic.com/settings/keys" target="_blank" class="text-article-blue hover:underline">console.anthropic.com</a>
                        </p>
                    </div>
                </div>

                {# Actions #}
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-dark-border">
                    <button
                        type="button"
                        onclick="document.getElementById('add-provider-modal').remove()"
                        class="px-4 py-2 text-sm font-medium text-dark-muted hover:text-white bg-dark-bg border border-dark-border rounded-lg hover:bg-dark-hover transition-colors"
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        id="save-provider-btn"
                        class="px-4 py-2 text-sm font-medium text-white bg-article-blue rounded-lg hover:bg-article-blue/90 transition-colors"
                    >
                        Save Provider
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function updateProviderForm() {
    const providerSelect = document.getElementById('provider_name');
    const provider = providerSelect.value;

    // Update display name
    const displayNameInput = document.getElementById('display_name');
    const displayNames = {
        'anthropic': 'My Anthropic API',
        'openai': 'My OpenAI API',
        'google': 'My Google API'
    };
    displayNameInput.value = displayNames[provider] || 'My API';

    // Show/hide model selects
    document.querySelectorAll('.provider-models').forEach(select => {
        if (select.dataset.provider === provider) {
            select.classList.remove('hidden');
            select.disabled = false;
        } else {
            select.classList.add('hidden');
            select.disabled = true;
        }
    });

    // Update API key help text
    const helpText = document.getElementById('api-key-help');
    const helpTexts = {
        'anthropic': 'Get your key from <a href="https://console.anthropic.com/settings/keys" target="_blank" class="text-article-blue hover:underline">console.anthropic.com</a>',
        'openai': 'Get your key from <a href="https://platform.openai.com/api-keys" target="_blank" class="text-article-blue hover:underline">platform.openai.com</a>',
        'google': 'Get your key from <a href="https://aistudio.google.com/apikey" target="_blank" class="text-article-blue hover:underline">aistudio.google.com</a>'
    };
    helpText.innerHTML = helpTexts[provider] || '';
}

// Initialize on load
updateProviderForm();
</script>
